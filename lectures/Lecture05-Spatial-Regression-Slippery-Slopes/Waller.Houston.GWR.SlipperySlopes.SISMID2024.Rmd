---
title: "Waller SISMID 2024:  Houston Crime Slippery Slopes"
author: "Lance A. Waller"
date: "7/17/2024"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Houston Crime Geographically Weighted Regression Example

This file reads in data from a shapefile of Houston census tracts (using the same code in the markdown file we used for Lecture 2). 

Next we will use "spgwr" to fit geographically weighted regression.

***

***Same code as in GIS example to open libraries, set working directory, and read in the Houston shapefile.***

```{r, output=F, message=F, warning=F}
##Load libraries

pacman::p_load(sf, #replaces "maptools", "rgdal" and other deprecated packages 
               tmap, #helps with plotting your map
               RColorBrewer, # creates nice color schemes
               ClassInt,  # finds class intervals for continuous variables
               GWmodel, # Adds the geographically weighted regression functions
               tidyverse,
               here # For constructing filepaths relative to root directory
               )


##Read in shapefile - Houston Census Tracts
houston = read_sf(dsn = here("data") , layer = "HoustonENAR2012final")

plot(houston)
```

***

Now to plot the map outlines (same code as before)

***

```{r}
##Map the tracts using plot...old school
plot(houston['POP2000'])
#Add a title
title(main="Population 2000",
      sub="Quantile (Equal-Frequency) Class Intervals")
# Here are the outlines

plot(houston)

```

***

Now set up the covariates and map the data (same code as Lecture 2)

***

```{r}
# Divide by the 2000 population to get the rate
houston$violence.rate = houston$violence_2/houston$tot_pop

violence_map <- tm_shape(houston) + 
  tm_fill('violence.rate', 
style='quantile', 
palette='BuPu', 
title='Violent Crimes \n Per Capita') + 
  tm_borders(alpha=0.2) + 
  tm_credits('Quantile (Equal-Frequency) Class Intervals', 
             position=c('RIGHT', 'BOTTOM')) + 
  tm_layout(main.title="Violent Crime Rate in Houston, TX",
            inner.margins = c(0.1, 0.1, 0.05, 0.05), 
            main.title.size=1.2, legend.title.size=0.8)
violence_map


alc_map <- tm_shape(houston) + 
  tm_fill('Zl_total', 
style='quantile', 
palette='BuPu', 
title='Standardized Log \n Total Alcohol Sales') + # "\n" moves text to the next line 
  tm_borders(alpha=0.2) + 
  tm_credits('Quantile (Equal-Frequency) Class Intervals', 
             position=c('RIGHT', 'BOTTOM')) + 
  tm_layout(main.title="Alcohol Sales in Houston, TX",
            inner.margins = c(0.1, 0.1, 0.05, 0.05), 
            main.title.size=1.2, legend.title.size=0.8)
alc_map

drug_map <- tm_shape(houston) + 
  tm_fill('Zl_drug', 
style='quantile', 
palette='BuPu', 
title='Standardized Log \n Illegal Drug Arrests') + 
  tm_borders(alpha=0.2) + 
  tm_credits('Quantile (Equal-Frequency) Class Intervals', 
             position=c('RIGHT', 'BOTTOM')) + 
  tm_layout(main.title="Illegal Drug Arrests in Houston, TX",
            inner.margins = c(0.1, 0.1, 0.05, 0.05), 
            main.title.size=1.2, legend.title.size=0.8)
drug_map


tmap_arrange(violence_map, alc_map, drug_map)
```
=======
# The data table has a lot of census data and various transformations
# of the violent crime, alcohol sales, and drug arrest data.  The next
# section pulls the values we want.

# Outcome:  Number of violent crimes by tract
violence = houston@data$violence_2

# Divide by the 2000 population to get the rate
violence.rate = violence/houston@data$tot_pop

# Covariate 1 (log standardized total alcohol sales)
Z.log.total = houston@data$Zl_total

# Covariate 2 (log standardized illegal drug arrests)
Z.log.drug = houston@data$Zl_drug

# set up maps 2 rows of 2 plots each.
#par(mfrow=c(2,2))

# Plot Outcome first
plot(houston)
# Define the number of classes
nclr <- 5  # quintiles
# Use RColorBrewer to choose the colors
plotclr <- brewer.pal(nclr,"BuPu")
class <- classIntervals(violence.rate, nclr, style="quantile")
colcode <- findColours(class, plotclr)
#Fill in the tracts with the colors
plot(houston, col=colcode, add=T)
#Add a title
title(main="Violence Rate",
    sub="Quantile (Equal-Frequency) Class Intervals")
#Add a legend  (Coordinates are in longitude, latitude).
legend(-95.7, 29.65, legend=names(attr(colcode, "table")),
    fill=attr(colcode, "palette"), cex=0.6, bty="n")

# Next plot stdized log total alcohol sales
plot(houston)
# Define the number of classes
nclr <- 5  # quintiles
# Use RColorBrewer to choose the colors
plotclr <- brewer.pal(nclr,"BuPu")
class <- classIntervals(Z.log.total, nclr, style="quantile")
colcode <- findColours(class, plotclr)
#Fill in the tracts with the colors
plot(houston, col=colcode, add=T)
#Add a title
title(main="Std log total sales",
    sub="Quantile (Equal-Frequency) Class Intervals")
#Add a legend  (Coordinates are in longitude, latitude).
legend(-95.7, 29.65, legend=names(attr(colcode, "table")),
    fill=attr(colcode, "palette"), cex=0.6, bty="n")

# Next plot stdized log illegal arrests
plot(houston)
# Define the number of classes
nclr <- 5  # quintiles
# Use RColorBrewer to choose the colors
plotclr <- brewer.pal(nclr,"BuPu")
class <- classIntervals(Z.log.drug, nclr, style="quantile")
colcode <- findColours(class, plotclr)
#Fill in the tracts with the colors
plot(houston, col=colcode, add=T)
#Add a title
title(main="Std log drug arrests",
    sub="Quantile (Equal-Frequency) Class Intervals")
#Add a legend  (Coordinates are in longitude, latitude).
legend(-95.7, 29.65, legend=names(attr(colcode, "table")),
    fill=attr(colcode, "palette"), cex=0.6, bty="n")

>>>>>>> 1229a265105ae69160fe8c28ca27647c2b02910c
# This matches Figure 1 in Waller et al. 2007
```

***

Now we are ready to fit *geographically weighted regression* (GWR).  GWR uses weighting to fit local regression values to allow the slopes associated with each covariate to change (smoothly) over space.  (See Lecture notes for details).  To estimate the association $\beta(s)$ for a location $s$, GWR uses kernel weights (similar to our intensity estimation for point process data) to weight observations (outcomes and covariates) near $s$ more to give an estimate of $\beta$ associated with location $s$. If you move over, the weights change and the estimated association ($\beta$).   The kernels make sure that if you don't move far, the estimate doesn't change much so we get a smooth surface for $\beta$.

We do this in two steps.  

First, we estimate the bandwidth for the kernel using cross validation (CV).

Next, we use the estimated bandwidth to fit the Poisson GWR model.

***

To get the bandwidth, "ggwr.sel" will test the cross validation score to find a minimum.

***

```{r, warning=FALSE }
### Now to fit Poisson GWR!
# The function 'ggwr' in the 'spgwr' package uses syntax similar to 'glm'
# (like we would use in a standard Poisson regression).
# 'longlat' tells the function that our coordinates are in longitude and
# latitude coordinates.
# 'ggwr.sel' selects the bandwidth for GWR based on the data, the model,
# and cross-validation
# Create distance matrix from centroids

houston.sp <- houston %>%
  as('Spatial')
DM <- gw.dist(dp.locat = coordinates(houston.sp))
head(houston)
houston.bw <- bw.gwr (violence_2 ~ Zl_total + Zl_drug + offset(log(POP2000)), 
             data = houston.sp, 
             adaptive=TRUE, 
             dMat=DM)

bgwr <- ggwr.basic(violence_2 ~ Zl_total + Zl_drug + offset(log(POP2000)), 
                      data =houston.sp,
                      family = "poisson",
                      bw = houston.bw, 
                      kernel = "bisquare", 
                      adaptive = TRUE,
                      dMat = DM)
```

Model Diagnostics 

First, check local multi-collinearity

```{r}
collin <- gwr.collin.diagno(violence_2 ~ Zl_total + Zl_drug + offset(log(POP2000)),
                            data = houston.sp,
                            adaptive = T,
                            dMat = DM,
                            bw = houston.bw)
                            
names(collin$SDF)

summary(collin$SDF$'local_CN')

#Plot local condtion number 
tm_shape(collin$SDF) +
  tm_fill('local_CN',
          style = 'fixed',
          breaks = c(0,15,25,30,35),
          palette = '-PRGn')+
  tm_borders(alpha = 0.2) 
  
## Looks good! 


#Plot variance inflation factor

tm_shape(collin$SDF) +
  tm_fill(c('Zl_total_VIF', 'Zl_drug_VIF'),
          style = 'fixed',
          breaks = c(0,1, 2, 3, 4),
          palette = '-PRGn') +
  tm_borders(alpha = 0.2) 
```


***
Now to map the results.

The houston.ggwr object contains an element called SDF which contains the spatial data frame (SDF) of the outcomes.  We will want to map the (spatially varying) intercept and the parameters associated with each of our two covariates.  The notation is tricky since the spatial data frame is within the
 houston.ggwr object.
 
***

```{r, warning=FALSE}
# Create a spatial object delineating statistically significant INTERCEPT coefficients
names(bgwr$SDF)
t.adj <- gwr.t.adjust(bgwr)

intercept.p <- t.adj$SDF %>%
  st_as_sf() %>%
  mutate(pval = ifelse(Intercept_p_by <0.05, 1, 0)) %>%
  group_by(pval) %>%
  summarise(count = n()) %>%
  filter(pval ==1)
intercept.p

# Create a spatial object delineating statistically significant DRUG coefficients
drug.p <- t.adj$SDF %>%
  st_as_sf() %>%
  mutate(pval = ifelse(Zl_drug_p_by <0.05, 1, 0)) %>%
  group_by(pval) %>%
  summarise(count = n()) %>%
  filter(pval ==1)
drug.p

# Create a spatial object delineating statistically significant ALCOHOL coefficients
alc.p <- t.adj$SDF %>%
  st_as_sf() %>%
  mutate(pval = ifelse(Zl_total_p_by <0.05, 1, 0)) %>%
  group_by(pval) %>%
  summarise(count = n()) %>%
  filter(pval ==1)

alc.p
```

***

These are very smooth maps.   Let's try it with a smaller bandwidth.

***

```{r, warning=FALSE}
# Try with a smaller, fixed bandwidth (1/4 the size of the other)
# This is closer to what is presented in Figure 5 of Waller et al. 2007

ggwr =ggwr.basic(violence_2 ~ Zl_total + Zl_drug + offset(log(POP2000)), 
                      data =houston.sp,
                      family = "poisson",
                      bw = houston.bw/4, 
                      kernel = "bisquare", 
                      adaptive = TRUE,
                      dMat = DM)
                    
# Now to map the outcomes

# The houston.ggwr object contains an element called SDF which contains
# the spatial data frame (SDF) of the outcomes.
# We will want to map the (spatially varying) intercept and the parameters
# associated with each of our two covariates.
#  The notation is tricky since the spatial data frame is within the
# houston.ggwr object.
ggwr$SDF@data
intercepts = ggwr$SDF@data$X.Intercept
alcohol.effects = ggwr$SDF@data$Z.log.total
drug.effects = ggwr$SDF@data$Z.log.drug

# Plot the outlines first
plot(houston)
# Define the number of classes
nclr <- 5  # quintiles
# Use RColorBrewer to choose the colors
plotclr <- brewer.pal(nclr,"BuPu")
class <- classIntervals(intercepts, nclr, style="quantile")
colcode <- findColours(class, plotclr)
#Fill in the tracts with the colors
plot(houston, col=colcode, add=T)
#Add a title
title(main="GGWR Intercepts",
    sub="Quantile (Equal-Frequency) Class Intervals")
#Add a legend  (Coordinates are in longitude, latitude).
legend(-95.7, 29.65, legend=names(attr(colcode, "table")),
    fill=attr(colcode, "palette"), cex=0.6, bty="n")

# Plot the outlines first
plot(houston)
# Define the number of classes
nclr <- 5  # quintiles
# Use RColorBrewer to choose the colors
plotclr <- brewer.pal(nclr,"BuPu")
class <- classIntervals(alcohol.effects, nclr, style="quantile")
colcode <- findColours(class, plotclr)
#Fill in the tracts with the colors
plot(houston, col=colcode, add=T)
#Add a title
title(main="GGWR Alcohol",
    sub="Quantile (Equal-Frequency) Class Intervals")
#Add a legend  (Coordinates are in longitude, latitude).
legend(-95.7, 29.65, legend=names(attr(colcode, "table")),
    fill=attr(colcode, "palette"), cex=0.6, bty="n")

# Plot the outlines first
plot(houston)
# Define the number of classes
nclr <- 5  # quintiles
# Use RColorBrewer to choose the colors
plotclr <- brewer.pal(nclr,"BuPu")
class <- classIntervals(drug.effects, nclr, style="quantile")
colcode <- findColours(class, plotclr)
#Fill in the tracts with the colors
plot(houston, col=colcode, add=T)
#Add a title
title(main="GGWR Drug",
    sub="Quantile (Equal-Frequency) Class Intervals")
#Add a legend  (Coordinates are in longitude, latitude).
legend(-95.7, 29.65, legend=names(attr(colcode, "table")),
    fill=attr(colcode, "palette"), cex=0.6, bty="n")
```
